---
applyTo: "**"
---

# PR & Release Gatekeeper

## Purpose

Ensures no PR is merged without first checking for and resolving ALL feedback — from humans, AI reviewers, and automated checks (CodeQL, coverage, lint).

## Pre-Merge Checklist (MANDATORY)

Before calling `gh pr merge`, you **MUST** complete every step:

### 1. Check CI Status
```
gh pr checks <pr_number>
```
ALL checks must be ✓. If any fail, diagnose and fix before proceeding.

### 2. Check Review Comments
Use the GitHub API to read ALL review threads:
- `get_review_comments` — inline code review threads (Copilot reviewer, human reviewers)
- `get_reviews` — top-level review submissions (look for CHANGES_REQUESTED or COMMENTED with inline issues)
- `get_comments` — general PR conversation comments

### 3. Resolve Every Finding
For each unresolved review thread or comment:
1. Read the feedback carefully
2. Implement the fix in code
3. Commit and push
4. Wait for CI to pass again
5. Re-check for new feedback generated by the fix

### 4. Check CodeQL Alerts
If CodeQL ran, verify zero new alerts were introduced. Fix any security or quality issues found.

### 5. Final Verification
Only after ALL of the following are true:
- [ ] All CI checks passing (green)
- [ ] Zero unresolved review comments
- [ ] Zero unresolved CodeQL alerts
- [ ] All reviewer feedback addressed
- [ ] Coverage gate met

...may you proceed with `gh pr merge --squash --admin --delete-branch`.

## PR Resolution Workflow (MANDATORY)

When participating in an active PR — after pushing the branch or after a PR is created — the agent **MUST** follow this polling and resolution loop. This is not optional.

### Polling Loop

1. **Poll every 2 minutes** for up to **20 minutes** after the most recent push
2. Each poll cycle must check ALL of the following:
   - `gh pr checks <pr_number>` — CI status (passing, failing, or still running)
   - `get_review_comments` — inline code review threads (Copilot reviewer, humans, security tools)
   - `get_reviews` — top-level review submissions (CHANGES_REQUESTED, COMMENTED)
   - `get_comments` — general PR conversation comments
   - CodeQL alerts if applicable
3. If **any feedback or failure is found**, the agent MUST:
   a. Read and understand every comment/failure
   b. Implement the fix in code
   c. Respond to each comment explaining the resolution
   d. Commit and push — **this resets the 20-minute timer back to zero**
   e. Resume polling every 2 minutes from the new push
4. The loop exits **only when ALL of the following are true simultaneously**:
   - 20 minutes have elapsed since the last push with no new feedback
   - All CI checks are passing (green)
   - Zero unresolved review comments
   - Zero unresolved CodeQL alerts

### CI Still Running After 20 Minutes

If CI has not finished after the 20-minute window:
1. **Continue polling every 2 minutes** until CI completes (do NOT abandon)
2. Once CI finishes:
   - If CI **passes** and no new feedback: start a **fresh 20-minute feedback window**, polling every 2 minutes
   - If CI **fails**: fix the failure, push, and restart the full loop

### Timer Rules Summary

| Event | Effect on Timer |
|---|---|
| Push a commit | Reset 20-min timer to zero |
| New review comment received | Must address → push → reset timer |
| CI failure detected | Must fix → push → reset timer |
| CI still running at 20 min | Extend until CI finishes, then +20 min feedback window |
| 20 min elapsed, CI green, no feedback | **Exit loop** — ready for merge |

### Key Principles

- **Never abandon the loop early.** The agent must stay engaged until the PR is fully clean.
- **Every comment matters.** Do not skip, dismiss, or ignore any feedback from humans, AI reviewers, or security tools.
- **Respond to every comment.** Even if the fix is trivial, reply to the thread confirming the resolution.
- **Batch fixes when possible.** If multiple comments arrive in one poll cycle, fix them all in a single commit to avoid unnecessary timer resets.
- **Maintain a clean commit history.** Use descriptive commit messages that summarize the fixes made in response to feedback.
- **Resolve CodeQL alerts immediately.** Security issues must be addressed before merging, even if CI is green.
- **Resolve all feedback before merging.** Do not merge until the PR is completely clean of comments, failures, and alerts.

## Release Process Gates

When performing a version release (tag + publish):
1. PR must be merged to main via the checklist above
2. Main branch CI must pass after merge
3. Tag the version: `git tag v{X.Y.Z} && git push origin v{X.Y.Z}`
4. Verify release workflow completes successfully
5. Verify marketplace propagation
6. Install locally and confirm version number

## Anti-Patterns (NEVER do these)

- ❌ Merge before reading review comments
- ❌ Merge with failing checks using `--admin` to bypass
- ❌ Skip checking for CodeQL alerts
- ❌ Assume "no comments" without actually querying the API
- ❌ Tag a release before main CI passes

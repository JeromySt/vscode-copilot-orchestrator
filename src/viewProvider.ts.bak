
import * as vscode from 'vscode';
import { Job } from './jobRunner';
export class JobsViewProvider implements vscode.WebviewViewProvider { 
  public static readonly viewType='orchestrator.jobsView'; 
  private _view?:vscode.WebviewView; 
  private _jobs: Job[] = []; 
  constructor(private readonly _context:vscode.ExtensionContext){}
  
  resolveWebviewView(view:vscode.WebviewView, context: vscode.WebviewViewResolveContext, _token: vscode.CancellationToken){ 
    this._view=view; 
    view.webview.options = {
      enableScripts: true,
      localResourceRoots: []
    }; 
    view.webview.html = this.html(); 
    
    // Handle messages from webview
    view.webview.onDidReceiveMessage(message => {
      if (message.command === 'showJobDetails') {
        vscode.commands.executeCommand('orchestrator.showJobDetails', message.jobId);
      } else if (message.command === 'contextMenu') {
        this.showContextMenu(message.jobId);
      }
    });
    
    // Send current data immediately after view is ready
    this.refresh();
  }
  
  setJobs(jobs: Job[]){ 
    this._jobs = jobs; 
    this.refresh(); 
  }
  
  private refresh(){ 
    if (!this._view) return; 
    this._view.webview.postMessage({ 
      jobs: this._jobs || [], 
      running: (this._jobs || []).filter(j=>j.status==='running').length 
    }); 
  }
  
  private async showContextMenu(jobId: string) {
    const job = this._jobs.find(j => j.id === jobId);
    if (!job) return;
    
    const items: vscode.QuickPickItem[] = [
      { label: '$(output) Show Logs', description: 'View job details and logs' },
      { label: '$(debug-restart) Retry', description: 'Retry this job' },
      { label: '$(folder-opened) Open Worktree', description: 'Open job worktree folder' },
      { label: '$(trash) Delete', description: 'Remove this job' }
    ];
    
    if (job.status === 'running') {
      items.splice(1, 0, { label: '$(debug-stop) Stop', description: 'Cancel running job' });
    }
    
    const choice = await vscode.window.showQuickPick(items, { placeHolder: `Job: ${jobId}` });
    if (!choice) return;
    
    if (choice.label.includes('Show Logs')) {
      vscode.commands.executeCommand('orchestrator.showJobDetails', jobId);
    } else if (choice.label.includes('Retry')) {
      vscode.commands.executeCommand('orchestrator.retryJob', jobId);
    } else if (choice.label.includes('Stop')) {
      vscode.commands.executeCommand('orchestrator.cancelJob', jobId);
    } else if (choice.label.includes('Open Worktree')) {
      vscode.commands.executeCommand('orchestrator.openJobWorktree', jobId);
    } else if (choice.label.includes('Delete')) {
      vscode.commands.executeCommand('orchestrator.deleteJob', jobId);
    }
  }
  
  private html(){ 
    return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{font:12px/1.4 -apple-system,Segoe UI,Roboto,sans-serif;padding:8px;margin:0}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .pill{padding:2px 6px;border-radius:6px;background:#4443;font-size:11px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #4444;padding:4px 6px;text-align:left}
    th{font-weight:600;font-size:11px}
    td{font-size:11px}
    .empty{padding:16px;text-align:center;opacity:0.6}
    tr.clickable{cursor:pointer}
    tr.clickable:hover{background:#4442}
    .status-failed{color:#f48771}
    .status-succeeded{color:#89d185}
    .status-running{color:#3794ff}
    .status-queued{color:#cccccc}
    .status-canceled{color:#cccccc}
  </style>
</head>
<body>
  <div class="row">
    <h3 style="margin:0">Jobs</h3>
    <span class="pill" id="running">0 running</span>
  </div>
  <div id="content">
    <div class="empty">No jobs yet</div>
  </div>
  <script>
    const vscode = acquireVsCodeApi();
    const content = document.getElementById('content');
    const running = document.getElementById('running');
    
    window.addEventListener('message', ev => {
      const d = ev.data;
      running.textContent = (d.running || 0) + ' running';
      const jobs = d.jobs || [];
      
      if (jobs.length === 0) {
        content.innerHTML = '<div class="empty">No jobs yet</div>';
      } else {
        content.innerHTML = '<table><thead><tr><th>Job</th><th>Status</th><th>Duration</th><th>Session</th></tr></thead><tbody id="rows"></tbody></table>';
        const rows = document.getElementById('rows');
        rows.innerHTML = jobs.map(j => {
          const duration = j.endedAt && j.startedAt 
            ? Math.round((j.endedAt - j.startedAt) / 1000) + 's'
            : j.startedAt ? 'running...' : '';
          const session = j.copilotSessionId ? j.copilotSessionId.substring(0, 8) + '...' : '-';
          const step = j.currentStep || (j.status === 'failed' ? 'failed' : '-');
          const stepInfo = j.stepStatuses ? 'Pre:' + (j.stepStatuses.prechecks || '-') + ' Work:' + (j.stepStatuses.work || '-') + ' Post:' + (j.stepStatuses.postchecks || '-') : '';
          return '<tr class="clickable" onclick="showJob(' + JSON.stringify(j.id) + ')" oncontextmenu="showContextMenu(' + JSON.stringify(j.id) + ', event)" title="ID: ' + j.id + '\\nSteps: ' + stepInfo + '">' +
            '<td>' + j.name + '</td>' +
            '<td class="status-' + j.status + '">' + j.status + '</td>' +
            '<td>' + duration + '</td>' +
            '<td>' + session + '</td>' +
          '</tr>';
        }).join('');
      }
    });
    
    function showJob(jobId) {
      vscode.postMessage({ command: 'showJobDetails', jobId: jobId });
    }
    
    function showContextMenu(jobId, event) {
      event.preventDefault();
      vscode.postMessage({ command: 'contextMenu', jobId: jobId });
    }
  </script>
</body>
</html>`; 
  }
}
